{% extends "layout.html" %}
{% block title %}UWI Map{% endblock %}
{% block page %}UWI Map{% endblock %}

{{ super() }}

{% block content %}
    <div id="loading-bar" class="progress" style="position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; display: none; margin: 0;">
        <div class="indeterminate"></div>
    </div>
    <div style="position: fixed; top: 10px; right: 6px; z-index: 900;">
        <form action='/logout' style="margin-left: 1em;">
            <button type="submit" name='logoutBtn' id='logoutBtn' class="btn waves-effect waves-light white black-text">Logout</button>
        </form>
        <form action='/' style='margin-top: 1em;'>
            <button type="submit" name='logoutBtn' id='logoutBtn' class="btn waves-effect waves-light blue black-text">Guest View</button>
        </form>
    </div>
    <div id="map" style="height: 100vh; width: 100%; position: fixed; top: 0; left: 0;"></div>
    <div id="pane" class="card col s4 grey lighten-4" style="position: fixed; top: 50%; left: -300px; transform: translateY(-50%); z-index: 1000; width: 300px; background: white; overflow-x:hidden; transition: left 0.3s ease; height:100%">
    </div>
{% endblock %}

{% block code %}
    <script type="text/javascript">
        let buildingIdMap = {};
        var map = L.map('map').setView([10.642529, -61.400225], 13); // Sets the initial map position and zoom level
        var markers;
        var faculties;
        var buildings;

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        M.toast({html: 'Tip: You can double click buildings!'})

        //Adds the drawing controls to the map
        var drawControl = new L.Control.Draw({
            position: 'bottomright',
            draw: {
                circlemarker: false,
                circle: false,
                polyline: false,
                rectangle: false
            },
            edit: {
                featureGroup: drawnItems,
                edit: false,
                remove: false
            }
        });

        //Adds the get location button
        L.control.locate({
            position: 'bottomright',
            strings: {
                title: "Pan to current location"
            },
            keepCurrentZoomLevel: true
        }).addTo(map);
        
        //Custom written extension of L.Control
        L.Control.Recenter = L.Control.extend({
            onAdd: function() {
                var button = L.DomUtil.create('button', 'leaflet-control-recenter');
                button.title = "Recenter map";
                button.innerHTML = `<img src="https://www.freeiconspng.com/uploads/maps-center-direction-icon-24.png" alt="Recenter" style="width: 20px; height: 20px; border: 1px solid grey; border-radius: 50%;">`;
                button.onclick = recenterMap;
                return button;
            },
            onRemove: function() {}
        });

        L.control.recenter = function(opts) {
            return new L.Control.Recenter(opts);
        };

        //Adds the recenter button to the map
        L.control.recenter({ position: 'bottomright' }).addTo(map);

        var mode = 'view';
        var currentMarker;
        var currentBuilding;
        var previousDrawing = null;
        //Markers and buildings go on these 2 layers
        var drawingLayer = L.geoJSON().addTo(map)
        var markerLayer = L.layerGroup();

        //Layergroups here will be used for filters
        var eng = L.layerGroup();
        var fst = L.layerGroup();
        var fhe = L.layerGroup();
        var fol = L.layerGroup();
        var ffa = L.layerGroup();
        var fss = L.layerGroup();
        var fms = L.layerGroup();
        var fsp = L.layerGroup();
        var admin = L.layerGroup();
        var other = L.layerGroup();

        var f0 = L.layerGroup();
        var f1 = L.layerGroup();
        var f2 = L.layerGroup();
        var f3 = L.layerGroup();
        var f4 = L.layerGroup();
        var f5 = L.layerGroup();
        var f6 = L.layerGroup();

        const floors = [f0, f1, f2, f3, f4, f5, f6]
        const shortFaculties = [eng, fst, fhe, fol, ffa, fss, fms, fsp, admin, other]

        var facultyLayers = [
            {
                label: "Faculties",
                selectAllCheckbox: true,
                collapsed: true,
                children: [
                    {
                        label: 'ENG',
                        layer: eng
                    },
                    {
                        label: 'FST',
                        layer: fst
                    },
                    {
                        label: 'FHE',
                        layer: fhe
                    },
                    {
                        label: 'FOL',
                        layer: fol 
                    },
                    {
                        label: 'FFA',
                        layer: ffa
                    },
                    {
                        label: 'FSS',
                        layer: fss
                    },
                    {
                        label: 'FMS',
                        layer: fms
                    },
                    {
                        label: 'FSP',
                        layer: fsp
                    },
                    {
                        label: 'Admin/Guild',
                        layer: admin
                    },
                    {
                        label: 'Other',
                        layer: other
                    }
                ]
            },
            {
                label: "Floors",
                selectAllCheckbox: true,
                collapsed: true,
                children: [
                    {
                        label: 'Floor 0',
                        layer: f0
                    },
                    {
                        label: 'Floor 1',
                        layer: f1
                    },
                    {
                        label: 'Floor 2',
                        layer: f2
                    },
                    {
                        label: 'Floor 3',
                        layer: f3
                    },
                    {
                        label: 'Floor 4',
                        layer: f4
                    },
                    {
                        label: 'Floor 5',
                        layer: f5
                    },
                    {
                        label: 'Floor 6',
                        layer: f6
                    }
                ]
            }
        ]
        //Adds the filter button
        var layerControl = L.control.layers.tree(null, facultyLayers, { position: 'bottomright', collapsed: true}).addTo(map);

        //These 2 sets will hold the currently selected filters to implement our custom filter functionality. All selected by default
        var filterSelectedFaculties = new Set([
        "ENG",
        "FST",
        "FHE",
        "FOL",
        "FFA",
        "FSS",
        "FMS",
        "FSP",
        "Admin/Guild",
        "Other"
        ])

        var filterSelectedFloors = new Set([
           "Floor 0",
           "Floor 1",
           "Floor 2",
           "Floor 3",
           "Floor 4",
           "Floor 5",
           "Floor 6"
        ])

        //Check all filter checkboxes and select all filters by default.
        for(let f of floors){
            f.addTo(map);
        }
        for(let fac of shortFaculties){
            fac.addTo(map);
        }

        //By default the filter button opens and closes when you hover in/out of the button. It's super annoying, so we just disabled it completely
        //by basically killing the event when it triggers.
        var control = document.querySelector('.leaflet-control-layers');
        ['mouseover', 'mouseenter', 'mouseout', 'mouseleave'].forEach(eventName => {
            control.addEventListener(eventName, function (e) {
              e.stopImmediatePropagation();
            }, true);
        });

        //This is our function that grabs data from the backend. Will be called anytime an the database is updated in someway.
        async function loadView(){
            await fetch('/get-data')
                .then(response => response.json())
                .then(data => {
                    markers = data['markers']
                    buildings = data['buildings']
                    faculties = data['faculties']
            })
            markerLayer.clearLayers();
            drawingLayer.clearLayers();
            drawnItems.clearLayers();
            addObjects(markers, buildings, faculties); // Call the addMarkers() function when the map loads
            searchFunctionality();
            filterMarkers();
            hideLoader(); //Hide the loading bar once it finishes loaded
            map.zoomIn(); //For some reason all the labels still show when the map first loads, so this zooms in the map 1 step which hides them. Small bug.
        }
        loadView();
        
        map.doubleClickZoom.disable();
        map.addControl(drawControl);
        
        //This is the logic that handles what happens when a new marker/drawing is placed on the map
        map.on(L.Draw.Event.CREATED, function(e){
            var layer = e.layer;
            var type = e.layerType;
            drawnItems.addLayer(layer); //Add the new item to the map

            //If the drawn item was a marker
            if(type === 'marker'){
                closeContainer();
                currentMarker = layer;
                let pane = document.querySelector('#pane');
                if (pane.innerHTML.trim() === '') {
                    //Form for adding markers
                    let html = `
    <div class="row" id="addMarkerForm">
        <div class="col s12">
            <div class="col s12" style="background-color: #d4edda;">
                <p style="font-family: 'Pridi', cursive">Add Marker</p>
                <button class="btn-floating btn-small transparent" style="position: absolute; top: 10px; right: 10px; z-index: 1500;" onclick="cancelAdd()">
                    <i class="material-icons">exit_to_app</i>
                </button>
            </div>
            <form action="/addMarker" method="POST" enctype="multipart/form-data" style='padding:2em;'>
                <div class="row">
                    <div class="input-field col s12">
                        <label for="markerName" style="position:static;">Name</label>
                        <input placeholder="eg. FST 114" id="markerName" name="markerName" type="text" class="validate" required>
                    </div>
                    <div class="input-field col s12">
                        <label for="floorNum" style="position:static;">Floor #</label>
                        <input placeholder="eg. 0" id="floorNum" name="floorNum" type="number" min="0" max="6" step="1" class="validate" required>
                    </div>
                    <div class="input-field col s12">
                      <label for="buildingAutocomplete" style="position:static;">Building</label>
                      <input type="text" id="buildingAutocomplete" name="buildingNameText" class="autocomplete" placeholder="eg. Natural Sciences Building" required>
                    </div>
                    <div class="input-field col s12">
                        <label for="description" style="position:static;">Description (Optional)</label>
                        <textarea class="materialize-textarea" placeholder="eg. Located on right of south entrance" name="description" id="description" rows="4" cols="12"></textarea>
                    </div>

                    <div class="input-field col s12">
                            <label for="imageUpload" style="position:static">Upload Image (Optional)</label>
                    </div>
                    <div class="file-field input-field col s12">
                        <div class="btn-small blue">
                            <span><i class="material-icons">file_upload</i></span>
                            <input type="file" name="imageUpload" id="imageUpload" accept="image/*">
                        </div>
                        <div class="file-path-wrapper">
                            <input class="file-path validate" type="text">
                        </div>
                    </div>
                    
                    <input type="hidden" name="x" id="x" value="${layer.getLatLng().lat}">
                    <input type="hidden" name="y" id="y" value="${layer.getLatLng().lng}">
                    <div class="input-field col s12">
                      <button class="waves-effect waves-light btn" type="submit">Add Marker</button>
                      <input class="waves-effect waves-light white btn black-text" type="button" value="Cancel" onclick="cancelAdd()">   
                    </div>
                </div>
            </form>
        </div>
    </div>`;
                pane.innerHTML = html;
                pane.style.left = '10px';
                let buildingData = {};

                //Populate data for autocomplete
                for (let building of buildings) {
                  buildingData[building.name] = null;
                  buildingIdMap[building.name] = building.id;
                }

                //Initialize Materialize autocomplete
                let buildingInput = document.getElementById('buildingAutocomplete');
                M.Autocomplete.init(buildingInput, {
                  data: buildingData,
                  limit: 3,
                  minLength: 0
                });
                
                //This event listener will interrupt the form submit to prevent the page from refreshing
                document.getElementById('addMarkerForm').addEventListener('submit', addMarker);
                //Materialize select fields need these 2 lines to of code to actually initialize the options for some reson
                var elems = document.querySelectorAll('select');
                var instances = M.FormSelect.init(elems);
                }
            }

            //If it was a building i.e. a shape:
            if(type === 'polygon' || type === 'circle' || type === 'rectangle'){
                if(currentMarker){
                    drawnItems.removeLayer(currentMarker); //Remove the previously placed unfinished marker if there was one
                }
                var geoJSON = layer.toGeoJSON();
                geoJSONString = JSON.stringify(geoJSON);
                if(mode === "redraw"){ //Check if this is a new building, or re-drawing a previous one.
                    if(currentBuilding != null && currentBuilding != undefined){
                        if(previousDrawing != null){
                            drawnItems.removeLayer(previousDrawing); //If redrawing a previous one, remove the previous drawing.
                        }    
                        previousDrawing = layer;
                        let field = document.querySelector('#newDrawingCoords');
                        field.value = geoJSONString;
                    }
                    currentBuilding = layer;
                    return;
                }
                closeContainer();
                currentBuilding = layer;
                let pane = document.querySelector('#pane');
                //Add building form. Can't actually add anything unless the edit button is clicked.
                let html = `
                <div class="row" id="addBuildingForm">
        <div class="col s12">
            <div class="col s12" style="background-color: #d4edda;">
                <p style="font-family: 'Pridi', cursive">Add Building</p>
                <button class="btn-floating btn-small transparent" style="position: absolute; top: 10px; right: 10px; z-index: 1500;" onclick="cancelAdd()">
                    <i class="material-icons">exit_to_app</i>
                </button>
            </div>
            <form action="/addBuilding" enctype="multipart/form-data" method="POST" style='padding:2em;'>
                <div class="row">
                    <div class="input-field col s12">
                        <label for="buildingName" style="position:static;">Building Name</label>
                        <input placeholder="egs. ENG Block 7, TCB #2" id="buildingName" name="buildingName" type="text" class="validate" required>
                    </div>
                    <div class="input-field col s12">
                        <label for="facultyName" style="position:static;">Faculty</label>
                        <select name="facultyChoice" id="facultyChoice" style="display:static;" required>
                            <option value="" disabled selected>Choose a faculty</option>
                    `;
                    //Populates the select with all the faculties
                    for(faculty of faculties){
                        html += `
                            <option value="${faculty['id']}">${faculty['abbr']} - ${faculty['name']}</option>
                        `
                    }

                    html += `
                        </select>
                    </div>
                    <div class="input-field col s12">
                        <label for="description" style="position:static;">Description (Optional)</label>
                        <textarea class="materialize-textarea" name="description" id="description" rows="4" cols="12"></textarea>
                    </div>
                    <div class="input-field col s12">
                        <label for="imageUpload" style="position:static;">Upload Image (Optional)</label>
                    </div>
                    <div class="file-field input-field col s12">
                        <div class="btn-small blue">
                            <span><i class="material-icons">file_upload</i></span>
                            <input type="file" name="imageUpload" id="imageUpload" accept="image/*">
                        </div>
                        <div class="file-path-wrapper">
                            <input class="file-path validate" type="text">
                        </div>
                    </div>

                    <input type="hidden" name="geoJSON" id="geoJSON" value='${geoJSONString}'>                    
                    <div class="input-field col s12">
                        <div style="display: flex; justify-content: center; gap: 10px;">
                            <button class="waves-effect waves-light btn" type="submit">Add Building</button>
                            <input class="waves-effect waves-light white btn black-text" type="button" value="Cancel" onclick="closeContainer()">   
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>`
                pane.innerHTML = html;
                pane.style.left = '10px';
                //Event listener to interrupt form submission
                document.getElementById('addBuildingForm').addEventListener('submit', addBuilding);
                //Materialize select fields need these 2 lines to of code to actually initialize the options for some reson
                var elems = document.querySelectorAll('select');
                var instances = M.FormSelect.init(elems);
            }
            removeUnhideButton(); // Remove unhide button
        });

        // Move zoom controls under the layer control toggle, with some CSS styling done in <style>
        map.zoomControl.setPosition('bottomright');

        //Event listener to interrupt addMarker form submission.
        async function addMarker(event){
            event.preventDefault(); //Prevent the default behavior
            let form = event.target.elements;
            let formData = new FormData(event.target); //Grab the form, then make a new FormData object with the forms fields and values

            //Uses building name to get id
            buildingInput = document.getElementById('buildingAutocomplete').value.trim();
            buildingId = buildingIdMap[buildingInput];

            if (!buildingId) {
                M.toast({ html: 'Please select a valid building from the suggestions.' });
                return;
            }

            formData.append('buildingChoice', buildingId); //Appends the building choice to the form
            
            //Sends a POST request to /addMarker with the data
            let response = await fetch('/addMarker', {
                method: 'POST',
                body: formData
            });
            let result = await response.json() //Get the result
            if('error' in result){
                toast(result['error']);
            } else {
                toast(result['success']);
                event.target.reset();
                closeContainer();
                loadView(); //Refresh the data on the map
            }
        }

        //Just closes the pane and removes the marker that was initially put down when adding a marker. May be modified to also remove cancelled buildings.
        function cancelAdd(){
            if(currentMarker != null && currentMarker != undefined){
                map.removeLayer(currentMarker);
            }
            if(currentBuilding != null && currentBuilding != undefined){
                drawnItems.removeLayer(currentBuilding);
            }
            closeContainer();
        }

        //Alot goes on here. 
        function addObjects(markers, buildings, faculties){
            for(marker of markers){
                var newMarker = L.marker([marker['x'], marker['y']], {title: marker['name']}).addTo(map); // Adds each marker to the map
                newMarker.on('click', onMarkerClick);
                //The marker object attributes from the backend is basically just recreated here, as newMarker.data
                newMarker.data = marker
                newMarker.bindTooltip(marker['name'], {permanent: true, offset: [-15, 40], direction: "center", className: 'transparent-tooltip'});
                var markerColorIcon;

                // Add each marker to the layerGroup
                markerLayer.addLayer(newMarker).addTo(map);
                //Dynamically change the color of the marker icon depending on the faculty.
                switch(marker['facultyAbbr']) {
                    case "FST":
                        fst.addLayer(newMarker).addTo(map);
                        markerColorIcon = "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png"
                        break;
                    case "FHE":
                        fhe.addLayer(newMarker).addTo(map);
                        markerColorIcon = "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png"
                        break;
                    case "ENG":
                        eng.addLayer(newMarker).addTo(map);
                        markerColorIcon = "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png"
                        break;
                    case "FOL":
                        fol.addLayer(newMarker).addTo(map);
                        markerColorIcon = "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png"
                        break;
                    case "FFA":
                        ffa.addLayer(newMarker).addTo(map);
                        markerColorIcon = "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png"
                        break;
                    case "FSS":
                        fss.addLayer(newMarker).addTo(map);
                        markerColorIcon = "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png"
                        break;
                    case "Admin/Guild":
                        admin.addLayer(newMarker).addTo(map);
                        markerColorIcon = "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png"
                        break;
                    default:
                        other.addLayer(newMarker).addTo(map);
                        markerColorIcon = "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png"
                        break;
                }

                var newIcon = L.icon({
                    iconUrl: markerColorIcon,
                    iconSize: [25, 41], 
                    iconAnchor: [12, 41],  
                    popupAnchor: [1, -34],
                    tooltipAnchor: [16, -28]
                  });
                newMarker.setIcon(newIcon);
            }

            //Recreating pseudo-building objects from the backend.
            for(building of buildings){
                var name = building['name'];
                var newDrawingCoords = JSON.parse(building['drawingCoords'])
                
                newDrawingCoords.properties["id"] = building['id']
                newDrawingCoords.properties["name"] = name;
                newDrawingCoords.properties["faculty"] = building['facultyAbbr']
                newDrawingCoords.properties["facultylong"] = building['facultyName']
                newDrawingCoords.properties["image"] = building['image']
                newDrawingCoords.properties["description"] = building['description']
                drawingLayer.addData(newDrawingCoords)
            }
            
            //Dynamically color each building depending on the faculty
            drawingLayer.eachLayer(function(layer){
                layer.bindTooltip(layer.feature.properties.name, {permanent: true, offset: [0, 0], direction: "center", className: 'transparent-tooltip-building'});
                var facultyColor;
                var fillFacultyColor;
                switch(layer.feature.properties.faculty) {
                    case "FST":
                        facultyColor='gold'
                        fillfacultyColor='yellow'
                        break;
                    case "FHE":
                        facultyColor='royalblue'
                        fillfacultyColor='royalblue'
                        break;
                    case "ENG":
                        facultyColor='slategrey'
                        fillfacultyColor='slategrey'
                        break;
                    case "FOL":
                        facultyColor='black'
                        fillfacultyColor='black'
                        break;
                    case "FFA":
                        facultyColor='green'
                        fillfacultyColor='green'
                        break;
                    case "FSS":
                        facultyColor='red'
                        fillfacultyColor='red'
                        break;
                    case "Admin/Guild":
                        facultyColor='purple'
                        fillfacultyColor='purple'
                        break;
                    default:
                        facultyColor='grey'
                        fillfacultyColor='grey'
                        break;
                }

                layer.setStyle({
                    color: facultyColor,
                    fillColor: fillFacultyColor,
                    weight: 1,
                    fillOpacity: 0.2
                  });
                layer.on('dblclick', onBuildingClick); //Double clicking a building will bring up the info pane for it.
            });
        }

        
        //Prepare and sort marker names
        markerNames = {};
        namesArray = [];

        function searchFunctionality(){
            markerLayer.eachLayer(function(layer) {
                namesArray.push(layer.data.name);
            });

            //Sort alphabetically
            namesArray.sort((a, b) => a.localeCompare(b));

            //Build autocomplete data object
            namesArray.forEach(function(name) {
                markerNames[name] = null;
            });
        }

        //Initialize Autocomplete with BOTH input and onAutocomplete handlers
        searchInput = document.getElementById('marker-search');
        M.Autocomplete.init(searchInput, {
            data: markerNames,
            minLength: 0,
            limit:3,
            onAutocomplete: function(selectedName) {
                filterMarkersByName(selectedName.toLowerCase());
            }
        });

        //Live filtering on input
        searchInput.addEventListener('input', function () {
            var query = this.value.trim().toLowerCase();
            filterMarkersByName(query);
        });

        //Filtering logic (shared between input and selection)
        function filterMarkersByName(query) {
            if (!query) {
                filterMarkers("none", "all");
                return;
            }

            markerLayer.eachLayer(function(layer) {
                markerName = layer.data.name.toLowerCase();
                if (markerName.includes(query)) {
                    if (!map.hasLayer(layer)) map.addLayer(layer);

                    //If exact match, center and zoom
                    if (markerName === query) {
                        map.setView(layer.getLatLng(), 18);
                        foundMatch = true;
                    }

                } else {
                    if (map.hasLayer(layer)) map.removeLayer(layer);
                }
            });
        }

        //Clears search input
        clearBtn = document.getElementById('clear-search');

        clearBtn.addEventListener('click', function () {
            searchInput.value = '';
            filterMarkers("none", "all"); //Reshow all markers
            recenterMap();
        });

        // Brings up the building info pane on double click
        function onBuildingClick(e) {
            if(currentBuilding){
                drawnItems.removeLayer(currentBuilding);
            }
            if(currentMarker){
                drawnItems.removeLayer(currentMarker);
            }

            mode = 'view';
            if(currentMarker){ //Disables dragging on the current marker if it was enabled before.
                if(currentMarker.dragging){
                    currentMarker.dragging.disable();
                }
            }

            currentBuilding = e.target.feature.properties; // Ensure currentBuilding is set correctly
            let pane = document.querySelector('#pane');
            let building = currentBuilding; // Use currentBuilding for consistency
            let html = `
    <div class="row" style="overflow-x: hidden;" id='editBuildingForm' name='editBuildingForm'>
        <div class="col s12">
            <div class="col s12" style="background-color: #a5d6a7">
                <p style="font-family: 'Pridi', cursive">Building Information</p>
                <button class="btn-floating btn-small transparent" style="position: absolute; top: 10px; right: 10px; z-index: 1500;" onclick="closeContainer()">
                    <i class="material-icons">exit_to_app</i>
                </button>
            </div>
            <form method="POST" enctype="multipart/form-data" action="/editBuilding/${building.id}">
            <div>`;
            if (building.image != '') {
                html += `
                <div class="card-image crop-box">
                    <img class="materialboxed full-img" src="${building.image}" height="200" style="border-radius: 0; object-fit:cover; object-position: 20% 10%;">
                </div>`;
            } else {
                html += `<div style="margin-top: 2.5em;"></div>`;
            }
            html += `
                <div name="buildingInfoForm" id="buildingInfoForm" class="card-content">
                    <h6 style="font-family: 'Pridi', cursive; color: #A5D6A7"><strong>Name</strong></h6>
                    <p style="font-family: 'Pridi', cursive">${building.name}</p>
                    <h6 style="font-family: 'Pridi', cursive; color: #A5D6A7"><strong>Faculty</strong></h6>
                    <p style="font-family: 'Pridi', cursive">${building.facultylong}</p>
                    <h6 style="font-family: 'Pridi', cursive; color: #A5D6A7"><strong>Description</strong></h6>`
                    if(building.description != ''){
                        html += `<p style="font-family: 'Pridi', cursive">${building.description}</p>`
                    } else {
                        html += `<p style="font-family: 'Pridi', cursive">No description provided</p>`
                    }
                html += `
                </div>
                <div name="buildingInfoFormButtons" id="buildingInfoFormButtons" class="card-action" style="position:static;">
                    <input type="button" onclick="editBuildingView()" class="waves-effect waves-light orange btn" value="Edit" style="font-family: 'Pridi', cursive">
                    <button type="button" onclick="deleteBuilding(${building.id})" class="waves-effect waves-light red btn right" style="font-family: 'Pridi', cursive">Delete</button>
                </div>
            </div>
            </form>
        </div>
    </div>`;
            pane.innerHTML = html;
            pane.style.left = '10px';

            
            document.getElementById('editBuildingForm').addEventListener('submit', editBuilding);
            // Initialize Materialboxed for the image
            var elems = document.querySelectorAll('.materialboxed');
            var instances = M.Materialbox.init(elems);
            removeUnhideButton(); // Remove unhide button
        }

        async function editBuilding(event){
            event.preventDefault();
            let form = event.target.elements;
            let formData = new FormData(event.target);
            let response = await fetch(`${event.target.action}`, {
                method: 'POST',
                body: formData
            });

            let result = await response.json()
            if('error' in result){
                toast(result['error']);
            } else {
                toast(result['success']);
                closeContainer();
                event.target.reset();
                loadView();
            }
        }

        //Brings up the edit form for buildings
        function editBuildingView(){
            let infoPane = document.querySelector('#buildingInfoForm');
            if(infoPane != undefined){
                html = `
                    <div class="input-field col s12">
                        <label for="markerName" style="position:static;">Name</label>
                        <input value="${currentBuilding.name}" id="buildingName" name="buildingName" type="text" class="validate" required>
                    </div>
                    <div class="input-field col s12">
                        <label for="facultyChoice" style="position:static;">Faculty</label>
                        <select name="facultyChoice" id="facultyChoice" style="display:static;">
                            
                    `;
                    for(faculty of faculties){
                        if(faculty['abbr'] != currentBuilding.faculty){
                            html += `
                               <option value="${faculty['id']}">${faculty['abbr']} - ${faculty['name']}</option>
                            `
                        } else {
                            html += `
                            <option value="${faculty['id']}" selected>${faculty['abbr']} - ${faculty['name']}</option>
                            `
                        }
                    }
                    html += `
                        </select>
                    </div>
                    <div class="input-field col s12">
                        <label for="description" style="position:static;">Description (Optional)</label>
                        <textarea class="materialize-textarea" name="description" id="description" rows="4" cols="12">${currentBuilding.description}</textarea>
                    </div>
                    <div>
                        <button class="waves-effect waves-light blue btn" type="button" onclick="reDraw()">Re-draw</button>
                        <div id="reDrawTooltip" name="reDrawTooltip"></div>
                        <input type="hidden" id="newDrawingCoords" name="newDrawingCoords" value="">
                    </div>

                    <div class="input-field col s12">
                        <label for="imageUpload" style="position:static">Change Image</label>
                    </div>
                    <div class="file-field col s12">
                        <div class="btn-small blue">
                            <span><i class="material-icons">file_upload</i></span>
                            <input type="file" name="imageUpload" id="imageUpload" accept="image/*">
                        </div>
                        <div class="file-path-wrapper">
                            <input class="file-path validate" type="text" value="${currentBuilding.image}">
                        </div>
                    </div> 

                `;
                infoPane.innerHTML = html;
                //Have to initialize select options once again
                var elems = document.querySelectorAll('select');
                var instances = M.FormSelect.init(elems);

                //This code replaces the button with the real button to actually submit the form
                var buttons = document.querySelector('#buildingInfoFormButtons');
                if (buttons != undefined) {
                    buttons.innerHTML = `
                    <div style="margin-top: 80px; margin-left: 10px; display: flex; flex-direction: column; gap: 10px;">
                      <button class="waves-effect waves-light orange btn" type="submit">Update Building</button>
                      <input class="waves-effect waves-light white btn black-text" type="button" value="Cancel" onclick="closeContainer()">    
                      <button class="waves-effect waves-light blue btn" type="button" onclick="hideInformation()">Hide</button>
                    </div>
                    `;
                }
            }
            removeUnhideButton(); // Remove unhide button
        }

        async function addBuilding(event){
            event.preventDefault();
            let form = event.target.elements;
            let formData = new FormData(event.target);
            
            let response = await fetch('/addBuilding', {
                method: 'POST',
                body: formData
            });

            let result = await response.json()

            if('error' in result){
                toast(result['error']);
            } else {
                toast(result['success']);
                event.target.reset();
                closeContainer();
                loadView();
            }
        }

        //Automatically hides labels if zoomed out to far to preserve performance
        map.on("zoomend", () => {
            const show = map.getZoom() >= 19;
            document.querySelectorAll('.transparent-tooltip-building, .transparent-tooltip').forEach(el => {
              el.style.opacity = show ? '1' : '0';
              el.style.visibility = show ? 'visible' : 'hidden';
            });
        });
        
        function reDraw(){
            //Whenever a new drawing is made, "mode" is checked. If it is "redraw", then creating a drawing updates the currently 
            //selected building's drawing coordinates instead of bringing up the Add New Building form.
            mode = "redraw";
            let tip = document.querySelector('#reDrawTooltip');
            tip.innerHTML = '<h6>Draw a new shape with the toolbar!</h6>'
        }

        function onEachFeature(feature, layer) {
            if (feature.properties && feature.properties.popupContent) {
                layer.bindPopup(feature.properties.popupContent);
            }
        }
        
        function onMarkerClick(e){
            if(currentBuilding){
                drawnItems.removeLayer(currentBuilding);
            }

            mode = 'view'
            marker = e.target
            currentMarker = marker;
            let pane = document.querySelector('#pane');
            //Brings up the edit marker form. The form sends a POST request to editMarker(which is interrupted by an event listener), however 
            //you can't actually submit this form by default. By default the form actually just displays the marker info.
            //There is an edit button at the bottom which, if clicked, replaces the contents of the form with editable fields, and a button which
            //actually submits the form. Very jank way of doing this.
            //The delete button is also here, but since a form can't send both a POST and a GET request to 2 differnet routes, the delete button just
            //calls a JS function thats sends a GET request to the deleteMarker route.
            let html = `
    <div class="row" id='editMarkerForm' name='editMarkerForm'>
        <div class="col s12">
        <div class ="col s12" style="background-color: #a5d6a7">
	        <p style="font-family: 'Pridi', cursive">Marker Information</p>
        </div>
            <form method="POST" action="/editMarker/${marker.data.id}" enctype="multipart/form-data">
            <div>`
            //Only add the image if one exists for the current marker
            if(marker.data.image != ''){
                html += `
                <div class="card-image crop-box">
                    <button class="btn-floating btn-small transparent" style="position: absolute; top: 10px; right: 10px; z-index: 1500;" onclick="closeContainer()">
                        <i class="material-icons">exit_to_app</i>
                    </button>
                    <img class="materialboxed full-img" src="${marker.data.image}" height="200" style="border-radius: 0; object-fit:cover; object-position: 20% 10%;">
                </div>
                `
            } else {
                html += `<button class="btn-floating btn-small transparent" style="position: absolute; top: 10px; right: 10px; z-index: 1500;" onclick="closeContainer()">
                            <i class="material-icons">exit_to_app</i>
                         </button>
                         <div style="margin-top: 2.5em;"></div>`
            }
            html += `
                <div name="markerInfoForm" id="markerInfoForm" class="card-content">
                    <span class="card-title"></span>
                    <h6 style="font-family: 'Pridi', cursive; color: #A5D6A7"><strong>Name</strong></h6>
                    <p style="font-family: 'Pridi', cursive">${marker.data.name}</p>
                    <h6 style="font-family: 'Pridi', cursive; color: #A5D6A7"><strong>Building</strong></h6>
                    <p style="font-family: 'Pridi', cursive">${marker.data.buildingName}</p>
                    <h6 style="font-family: 'Pridi', cursive; color: #A5D6A7"><strong>Floor Number</strong></h6>
                    <p style="font-family: 'Pridi', cursive">${marker.data.floor}</p>
                    <h6 style="font-family: 'Pridi', cursive; color: #A5D6A7"><strong>Description</strong></h6>`
                    if(marker.data.description != ''){
                        html += `<p style="font-family: 'Pridi', cursive">${marker.data.description}</p>`
                    } else {
                        html += `<p style="font-family: 'Pridi', cursive">No description provided</p>`
                    }
                    
                html += `</div>
                <div name="markerInfoFormButtons" id="markerInfoFormButtons" class="card-action" style="position:static;">
                    <input type="button" onclick="editMarkerView()" class="waves-effect waves-light orange btn" value="Edit" style="font-family: 'Pridi', cursive">
                    <button type="button" onclick="deleteMarker(${marker.data.id})" class="waves-effect waves-light red btn right" style="font-family: 'Pridi', cursive">Delete</button>
                </div>
            </div>
            </form>
        </div>
    </div>
            `;
            pane.innerHTML = html;
            pane.style.left = '10px';
            document.getElementById('editMarkerForm').addEventListener('submit', editMarker);
            // Initialize Materialboxed for the image
            var elems = document.querySelectorAll('.materialboxed');
            var instances = M.Materialbox.init(elems, {
                onCloseEnd: function() {
                    // Reinitialize scrollable behavior for marker popup and edit panel
                    let pane = document.querySelector('#pane');
                    if (pane) {
                        pane.style.overflow = 'auto';
                    }
                }
            });
            removeUnhideButton(); // Remove unhide button
        }
        
        async function editMarker(event){
            event.preventDefault();
            let form = event.target.elements;
            let formData = new FormData(event.target);

            //Uses building name to get id
            buildingInput = document.getElementById('buildingAutocomplete').value.trim();
            buildingId = buildingIdMap[buildingInput];

            if (!buildingId) {
                M.toast({ html: 'Please select a valid building from the suggestions.' });
                return;
            }

            formData.append('buildingChoice', buildingId);

            let response = await fetch(`${event.target.action}`, {
                method: 'POST',
                body: formData
            });

            let result = await response.json()
            if('error' in result){
                toast(result['error']);
            } else {
                toast(result['success']);
                closeContainer();
                event.target.reset();
                loadView();
            }
        }
        
        async function deleteMarker(id){
            let response = await fetch(`/deleteMarker/${id}`);

            let result = await response.json()
            if('error' in result){
                toast(result['error']);
            } else {
                toast(result['success']);
                closeContainer();
                loadView();
            }
        }

        async function deleteBuilding(id){
            let response = await fetch(`/deleteBuilding/${id}`);

            let result = await response.json()
            if('error' in result){
                toast(result['error']);
            } else {
                toast(result['success']);
                closeContainer();
            };
            loadView();
        }

        //If the edit button is clicked, then this function is what actually "makes" all the fields in the form editable and adds the real submit button
        function editMarkerView(){
            let infoPane = document.querySelector('#markerInfoForm');
            if(infoPane != undefined){
                html = `
                    <div class="input-field col s12">
                        <label for="markerName" style="position:static;">Name</label>
                        <input value="${currentMarker.data.name}" id="markerName" name="markerName" type="text" class="validate" required>
                    </div>
                    <div class="input-field col s12">
                        <label for="floorNum" style="position:static;">Floor #</label>
                        <input value="${currentMarker.data.floor}" id="floorNum" name="floorNum" type="number" min="0" max="6" step="1" class="validate" required>
                    </div>
                    <div class="input-field col s12">
                      <label for="buildingAutocomplete" style="position:static;">Building</label>
                      <input value="${currentMarker.data.buildingName}" type="text" id="buildingAutocomplete" name="buildingNameText" class="autocomplete" placeholder="eg. Natural Sciences Building" required>
                    </div>
                    <div class="input-field col s12">
                        <label for="description" style="position:static;">Description (Optional)</label>
                        <textarea class="materialize-textarea" name="description" id="description" rows="4" cols="12">${currentMarker.data.description}</textarea>
                    </div>
                    <div class="input-field col s12">
                        <label for="coords" style="position:static;">Current coordinates</label>
                        <div id="coords" name="coords">
                            <span style="white-space:nowrap">
                                <label for="x">X:  </label>
                                <input type="text" name="x" id="x" value="${currentMarker.getLatLng().lat}">
                            </span>
                            <span style="white-space:nowrap">
                                <label for="y">Y:  </label>
                                <input type="text" name="y" id="y" value="${currentMarker.getLatLng().lng}">
                            </span>
                            <sub style="color: grey;">(Drag marker to new location)</sub>
                        </div>
                    </div>
                        
                    <div class="input-field col s12">
                        <label for="imageUpload" style="position:static">Change Image</label>
                    </div>
                    <div class="file-field col s12">
                        <div class="btn-small blue">
                            <span><i class="material-icons">file_upload</i></span>
                            <input type="file" name="imageUpload" id="imageUpload" accept="image/*">
                        </div>
                        <div class="file-path-wrapper">
                            <input class="file-path validate" type="text" value="${currentMarker.data.image}">
                        </div>
                    </div> 
                `;
                infoPane.innerHTML = html;
                
                let buildingData = {};

                //Populate data for autocomplete
                for (let building of buildings) {
                    buildingData[building.name] = null;
                    buildingIdMap[building.name] = building.id;
                }

                //Initialize Materialize autocomplete
                let buildingInput = document.getElementById('buildingAutocomplete');
                M.Autocomplete.init(buildingInput, {
                    data: buildingData,
                    limit: 3,
                    minLength: 0
                });

                //Enables dragging the marker and automatically updates the hidden fields in the form for the coordinates
                currentMarker.dragging.enable();
                currentMarker.on('dragend', function(){
                    x = document.querySelector('#x');
                    y = document.querySelector('#y');
                    x.value = currentMarker.getLatLng().lat;
                    y.value = currentMarker.getLatLng().lng;
                })
                //Have to initialize select options once again
                var elems = document.querySelectorAll('select');
                var instances = M.FormSelect.init(elems);

                //This code replaces the button with the real button to actually submit the form
                var buttons = document.querySelector('#markerInfoFormButtons');
                if (buttons != undefined) {
                    buttons.innerHTML = `
                        <div style="margin-top: 700px; margin-left: 10px; display: flex; flex-direction: column; gap: 10px;">
                            <button class="waves-effect waves-light orange btn" type="submit">Update Marker</button>
                            <input class="waves-effect waves-light white btn black-text" type="button" value="Cancel" onclick="closeContainer(${currentMarker.getLatLng().lat}, ${currentMarker.getLatLng().lng})">
                            <button class="waves-effect waves-light blue btn" type="button" onclick="hideInformation()">Hide</button>
                        </div>
                    `;
                }
            }
            removeUnhideButton(); // Remove unhide button
        }

        //This function sort of servers a double purpose right now. It closes the info pane, but in the case of cancelling a marker addition/edit, it also
        //removes that marker from the map. Should probably separate.
        function closeContainer(oldLat=null, oldLng=null){
            let pane = document.querySelector('#pane');
            pane.innerHTML = '';
            pane.style.left = '-300px';
            if(currentMarker){ //Disables dragging on the current marker if it was enabled before.
                if(currentMarker.dragging){
                    currentMarker.dragging.disable();
                }
                if(oldLat != null && oldLng != null){
                    currentMarker.setLatLng([oldLat, oldLng]);
                }
            }
            if(currentBuilding){
                drawnItems.removeLayer(currentBuilding);
            }
            mode='view'
        }

        //This function isn't called in the current state of the website, but may be used/expanded later.
        function recenterMap() {
            map.setView([10.642529, -61.400225], 13);
        }
        
        //Clean basemap no building names
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
            minZoom: 16,
            maxZoom: 50,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
            subdomains: 'abcd'
        }).addTo(map);

        //Original basemap with building names
        /*L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            minZoom: 16,
            maxZoom: 50,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);*/
        // Prevent scrolling
        document.body.style.overflow = 'hidden';

        // Add the unhide button to the document body
        var unhideButton = document.createElement('button');
        unhideButton.innerHTML = 'Unhide';
        unhideButton.className = 'waves-effect waves-light green btn';
        unhideButton.style.position = 'fixed';
        unhideButton.style.bottom = '10px';
        unhideButton.style.left = '-300px'; // Initially hidden
        unhideButton.style.zIndex = '1500';
        unhideButton.onclick = unhideInformation;
        document.body.appendChild(unhideButton);

        // Function to hide the information panel
        function hideInformation() {
            let pane = document.querySelector('#pane');
            if (pane) {
                pane.style.left = '-300px';
                unhideButton.style.left = '10px'; // Show the unhide button
            }
        }

        // Function to unhide the information panel
        function unhideInformation() {
            let pane = document.querySelector('#pane');
            if (pane) {
                pane.style.left = '10px';
                unhideButton.style.left = '-300px'; // Hide the unhide button
            }
        }

        // Function to remove the unhide button
        function removeUnhideButton() {
            unhideButton.style.left = '-300px'; // Hide the unhide button
        }

        // Add swipe functionality for the pane
        let touchStartX, touchEndX;
        const pane = document.querySelector('#pane');

        pane.addEventListener('touchstart', e => {
            // Restrict swipe to ribbon or text, ignore buttons, input fields, materialboxed elements, and their overlays
            if (e.target.tagName === 'BUTTON' || 
                e.target.tagName === 'INPUT' || 
                e.target.tagName === 'TEXTAREA' || 
                e.target.tagName === 'SELECT' || 
                e.target.closest('.materialboxed') || 
                e.target.closest('.materialbox-overlay')) {
                return;
            }
            touchStartX = e.targetTouches[0].clientX;
        });

        pane.addEventListener('touchmove', e => {
            if (touchStartX !== undefined) {
                touchEndX = e.targetTouches[0].clientX;
            }
        });

        pane.addEventListener('touchend', () => {
            if (touchStartX !== undefined && touchStartX - touchEndX > 45) { // Swipe left to close
                closeContainer();
            }
            touchStartX = undefined; // Reset touchStartX
        });

        //Custom filter function as the default does not do what we need.
        function filterMarkers(filterName, mode){
            markerLayer.eachLayer(function(layer){ //For each marker
                if(mode == "add"){ 
                    if(filterName.length === 3 || filterName === "Admin/Guild" || filterName === 'Other'){ //If mode == "add", add the faculty to the selectedFaculties list if it is a faculty
                        filterSelectedFaculties.add(filterName);
                    } else if (filterName.includes("Floor")){ //Likewise for floors
                        filterSelectedFloors.add(filterName);
                    }
                } else if(mode == "remove"){ //Remove it from the list is mode = "remove"
                    if(filterName.length === 3 || filterName === "Admin/Guild" || filterName === 'Other'){
                        filterSelectedFaculties.delete(filterName);
                    } else if (filterName.includes("Floor")){
                        filterSelectedFloors.delete(filterName);
                    }
                }

                //If both the marker's current faculty and floor are present in the lists, then add it to the map, as it satisfies the filter conditions
                if(filterSelectedFaculties.has(layer.data.facultyAbbr) && filterSelectedFloors.has("Floor " + layer.data.floor)){
                    if(!map.hasLayer(layer)){
                        map.addLayer(layer)
                    }
                } else if(map.hasLayer(layer)){ //Otherwise remove it from the map if it was there already
                    map.removeLayer(layer)
                }
            });

            //These grab the 2 'select all' checkboxes for Floors and Faculties
            let floorHeader = getHeaderCheckboxByLabel("Floors");
            let facultiesHeader = getHeaderCheckboxByLabel("Faculties");
            if(filterSelectedFaculties.size < 10){ //If every faculty is not currently ticked, untick the select all box
                facultiesHeader.checked = false;
            } else {
                facultiesHeader.checked = true; //Otherwise tick it
            }

            if(filterSelectedFloors.size < 7){ //Likewise for floors
                floorHeader.checked = false;
            } else {
                floorHeader.checked = true;
            }
        }

        //By default the plugin for the filters does not actually do what is needed. It doesn't stack filters ontop of each other
        //Eg. I can't filter for floor 2 in FST, only by FST or only by Floor 2. This bit of code prevents the default behavior for the filters'
        //labels, and replaces them with custom behavior to implement the needed kind of filter.
        setTimeout(() => {
            var labels = document.querySelectorAll('.leaflet-layerstree-header-name'); //Grab all the labels
        
            labels.forEach(labelSpan => {
              labelSpan.addEventListener('click', function (e) { //For each label in the filters menu, stop the default behavior onClick;
                e.preventDefault();
                e.stopPropagation();
            
                    //These few lines just grab the name of the label by drilling down from the parent
                    var parentLabel = this.closest('.leaflet-layerstree-header-label'); //Grab the parent container
                    var checkbox = parentLabel?.querySelector('input[type="checkbox"]'); //Grab the checkbox
                    var layerName = this.textContent.trim(); //Grab the name
            
                    if(layerName == "Floors"){ //If the label clicked on wazs one of the 'select all' labels:
                        var floorGroup = parentLabel.closest('.leaflet-layerstree-node'); 
                        var floorCheckboxes = floorGroup.querySelectorAll('input[type="checkbox"]');
                        var toggleToChecked = !checkbox.checked;  // If the select all button for Floors was checked, uncheck it and vice versa.
                        floorCheckboxes.forEach(floorCheckbox => {
                            floorCheckbox.checked = toggleToChecked; //Also toggle all the children checkboxes
                        });
                    
                        filterSelectedFloors.clear() //Now clear the current list of filters applied
                        let floors = facultyLayers[1].children //The names of all the floor labels are in this structure
                        if(checkbox.checked == true){ //If the state of the select all checkbox was toggle from unchecked to checked:
                            for(let floor of floors){
                                filterSelectedFloors.add(floor['label']); //Add every floor to the current list of filtered floors.
                            }
                        }
                        filterMarkers(layerName, "all"); //Then call the custom filter function
                    
                    } else if (layerName == "Faculties"){ //Do the same for the Faculties select all button
                        var facultiesGroup = parentLabel.closest('.leaflet-layerstree-node');
                        var facultiesCheckboxes = facultiesGroup.querySelectorAll('input[type="checkbox"]');
                        var toggleToChecked = !checkbox.checked;
                    
                        facultiesCheckboxes.forEach(facultiesCheckbox => {
                            facultiesCheckbox.checked = toggleToChecked;
                        });
                        filterSelectedFaculties.clear()
                        let filterFaculties = facultyLayers[0].children
                        if(checkbox.checked == true){
                            for(let faculty of filterFaculties){
                                filterSelectedFaculties.add(faculty['label']);
                            }
                        }
                        filterMarkers(layerName, "all");

                    } else { //If none of the 2 above were true, then an individual checkbox was clicked, so just toggle that one.
                        if (checkbox.checked) {
                            filterMarkers(layerName, "remove"); //If it was checked before, uncheck it and remove it from the list of current filters
                            checkbox.checked = !checkbox.checked;
                        } else {
                            filterMarkers(layerName, "add"); //Otherwise check it and add it
                            checkbox.checked = !checkbox.checked;
                        }
                    }
                });
            });
        }, 300);

        //This function just grabs the select all DOM elements which are used in the filter function.
        function getHeaderCheckboxByLabel(labelText) {
            var headers = document.querySelectorAll('.leaflet-layerstree-header');
            for (let header of headers) {
              var labelSpan = header.querySelector('.leaflet-layerstree-header-name');
              if (labelSpan && labelSpan.textContent.trim() === labelText) {
                return header.querySelector('input[type="checkbox"]');
              }
            }
            return null;
        }

        function showLoader() {
            document.getElementById('loading-bar').style.display = 'block';
          }
          
        function hideLoader() {
            document.getElementById('loading-bar').style.display = 'none';
        }
        showLoader();
</script>
{% endblock %}